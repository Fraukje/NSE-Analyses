---
title: "NSE groepsgewijze significantie-berekeningen"
output:
  html_document:
    df_print: paged
---

Dit is een [R Markdown](http://rmarkdown.rstudio.com) Notebook waarin
voor de Nationale Student Enquete (NSE) groepsgewijze T-testen worden
uitgerekend. Dit bestaat proces bestaat uit de volgende stappen:

1.  Laden benodigde R-bibliotheken

2.  Inladen NSE benchmark bestand

3.  Groepen definiëren - HU totaal - Benchmark R6 - Benchmark A (alles)

4.  Kijken naar verdeling van data binnen groepen

5.  T-testen uitvoeren

6.  Resultaten wegschrijven

# 0. Laden R-bibliotheken

```{r libraries, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse) #Nodig voor add_column() functie
library(psych) #Nodig voor describeBy() functie
library(plyr) #Nodig voor rbind() functie
library(dplyr) #Nodig voor na_if() functie
```

# 1. Inladen NSE benchmark bestand (clean data)

```{r Inlezen .csv}
load("~/research-drive/M21033303_DenA (Projectfolder)/DA_Onderzoek/2021nse/data_in/NSE2021 nse_benchmark_clean.RData")
head(nse_benchmark_clean,10)
```

# 2. Groepen definiëren

Voor de analyse zijn nodig de vergelijkingsgroepen: HU, R6 (behalve HU)
en alles (behalve HU). Hiervoor wordt de volgende groepering aangebracht
in de data: HU, R6, O (waarbij O staat voor 'overig'). Groep 'alles
behalve HU' kan nu gemaakt worden door de groeperingen 'R6' en 'O' te
combineren.

Vervolgens is er een verschillende gelaagdheid (granulariteit) waarop de
groepen met elkaar vergeleken worden:

-   Totaal

-   Totaal per vorm (d.w.z.: voltijd, deeltijd, duaal)

-   Totaal per type HO (d.w.z.: bachelor, master, ad)

-   Opleiding totaal

-   Opleiding per vorm

```{r Definiëren analyse-groepen}
groepHU    <- "Hogeschool Utrecht"
groepR6    <- c("Hogeschool van Amsterdam", "De Haagse Hogeschool",                             "Hogeschool INHOLLAND",     "Hogeschool Leiden",                                "Hogeschool Rotterdam")
vormtypes  <- sort(unique(nse_benchmark_clean$Opleidingsvorm3))
HOtypes    <- sort(unique(nse_benchmark_clean$BaMa))

#Weergeven van de verschillende groepen
groepHU; groepR6; vormtypes; HOtypes
```

Aanmaken van logische vectoren op basis van bovenstaande
groepdefinities, waarmee in het vervolg eenvoudig datagroepen gekozen
kunnen worden. Elke vector bevat TRUE voor elk regel in de NSE benchmark
data binnen de groep valt, en FALSE als de rij buiten de groep valt.

```{r Logische vectoren opzetten}
#Aanmaken logische vectoren voor elke groep
vec_groepHU    <- nse_benchmark_clean$BrinNaamActueel == groepHU
vec_groepR6    <- nse_benchmark_clean$BrinNaamActueel %in% groepR6
vec_groepAL    <- nse_benchmark_clean$BrinNaamActueel != groepHU #alle instituten behalve de HU

#Maak voor elke opleidingsvorm een logische vector en sla op als lijst
vec_vorm <- vector(mode = "list", length(vormtypes))
for (i in vormtypes)
{
  vec_vorm[[i]]<- nse_benchmark_clean$Opleidingsvorm3 == vormtypes[i]
}
#Voeg nu een extra lijst toe die alle vormen meeneemt (totaal-berekening)
vec_vorm[[length(vormtypes)+1]] <- rep(TRUE, nrow(nse_benchmark_clean))
Nvorm <- length(vec_vorm)
NSEvormen <- append(vormtypes, "Totaal")

#Maak voor elke HOtype een logische verctor
vec_HO <- vector(mode = "list", length(HOtypes))
for (j in HOtypes)
{
  vec_HO[[j]]<- nse_benchmark_clean$BaMa == HOtypes[j]
}
#En extra lijst toevoegen voor HU-totaal
vec_HO[[length(HOtypes)+1]] <- rep(TRUE, nrow(nse_benchmark_clean))
NHO <- length(vec_HO)
NSEHOtypes <- append(HOtypes, "Totaal")

# Weergeven verschillende groepen
cat("Samenvatting student-aantallen per groep:")
summary(vec_groepHU)
summary(vec_groepR6)
summary(vec_groepAL)

```

# 3. NSE Vragen definities

De kolommen waarin de vraagresponses zich bevinden moeten aangegeven
worden.

```{r Lijst met vragen maken}
Nvragen <- length(vec_NSEvragen)
Neerste <- min(vec_NSEvragen)
cat("De volgende ",toString(Nvragen)," vragen zijn opgenomen in deze significantie berekening:")
NSEvragen
```

# 4. Samenvattende statistieken (exploratieve data analyse)

-   Kijken naar outliers
-   Kijken naar verdeling van data binnen groepen

```{r Descriptieve statistieken per vraag weergeven}
vraag <- 2
cat("Dit is de vraag: ", NSEvragen[vraag])
#Tijdelijke objecten aanmaken om data te bekijken
temp_HUscores   <- nse_benchmark_clean[vec_groepHU,vec_NSEvragen[vraag]]
temp_R6scores   <- nse_benchmark_clean[vec_groepR6,vec_NSEvragen[vraag]]
temp_ALscores   <- nse_benchmark_clean[vec_groepAL,vec_NSEvragen[vraag]]

temp_HUvorm     <- nse_benchmark_clean[vec_vorm[[1]]&vec_groepHU,                                                      vec_NSEvragen[vraag]]
temp_R6vorm     <- nse_benchmark_clean[vec_vorm[[2]]&vec_groepR6,                                                      vec_NSEvragen[vraag]]
temp_ALvorm     <- nse_benchmark_clean[vec_vorm[[3]]&vec_groepAL,                                                      vec_NSEvragen[vraag]]
temp_HOtype1    <- nse_benchmark_clean[vec_HO[[1]]&vec_groepHU,                                                        vec_NSEvragen[vraag]]
temp_HOtype2    <- nse_benchmark_clean[vec_HO[[2]]&vec_groepHU,                                                        vec_NSEvragen[vraag]]
temp_HOtype3    <- nse_benchmark_clean[vec_HO[[3]]&vec_groepHU,                                                        vec_NSEvragen[vraag]]

table(temp_ALscores)

#Histogrammen plotten
hist(temp_ALscores); hist(temp_HUscores); hist(temp_R6scores)
hist(temp_HUvorm); hist(temp_R6vorm); hist(temp_ALvorm)
hist(temp_HOtype1);hist(temp_HOtype2); hist(temp_HOtype3)

#Weggooien tijdelijke objecten
rm(list=ls(pattern="^temp_"))
```

# 5. Samenvattende statistieken

Algemene statistieken bekijken voor alle vragen, per groep.

```{r Statistieken voor alle vragen}

describeBy(nse_benchmark_clean[,vec_NSEvragen], vec_groepHU)
describeBy(nse_benchmark_clean[,vec_NSEvragen], vec_groepR6)
describeBy(nse_benchmark_clean[,vec_NSEvragen], vec_groepAL)

```

# 6. Significanties uitrekenen

Voor de vergelijkingen tussen groepen wordt de Welch T-test gebruikt:
deze doet geen aannames over gelijke varianties tussen de testgroepen.
Doordat je groepen met verschillende groepsgroottes vergelijkt is het
namelijk mogelijk dat de varianties tussen groepen verschilt.

```{r T-test statistiek}
#Bijeen zoeken van responsdata per groep
HUscores    <- nse_benchmark_clean[vec_groepHU,]
R6scores    <- nse_benchmark_clean[vec_groepR6,]
ALscores    <- nse_benchmark_clean[vec_groepAL,]

#Pre-allocatie van objecten die in de volgende stap gevuld gaan worden
p_HUR6      <- array(NA, c(Nvragen, Nvorm, NHO))
p_HUAL      <- array(NA, c(Nvragen, Nvorm, NHO))
gem_HU      <- array(NA, c(Nvragen, Nvorm, NHO))
gem_R6      <- array(NA, c(Nvragen, Nvorm, NHO))
gem_AL      <- array(NA, c(Nvragen, Nvorm, NHO))
diff_HUR6   <- array(NA, c(Nvragen, Nvorm, NHO))
diff_HUAL   <- array(NA, c(Nvragen, Nvorm, NHO))

#Definieer correctiefactor zodat index voor het vullen van p waardes op 1 begint en niet op 28
Ncor <- Neerste + 1 

i_ho <- 1

#Voor elke vorm onderstaande berekening herhalen
for (i_vorm in 1:Nvorm)
{

  #Voor elke NSEvraag de respons tussen groepen vergelijken en p waarde opslaan
  for (i_vraag in vec_NSEvragen)

  {
    #Groepsgroote moet minimaal 5 responses zijn
    if (sum(!is.na(HUscores[(vec_HO[[i_ho]] & vec_vorm[[i_vorm]]),i_vraag])) < 5)
    {
      next #Sla groep over en ga naar volgende iteratie
    }
    else
    {
    #Berekenen p waarden
    p_HUR6[i_vraag-Ncor,i_vorm,i_ho]  <- t.test(HUscores[vec_HO[[i_ho]]                                                                 &vec_vorm[[i_vorm]]                                                              ,i_vraag],                                                             R6scores[vec_HO[[i_ho]]                                                                 &vec_vorm[[i_vorm]]                                                              ,i_vraag]                                                             )$p.value
    p_HUAL[i_vraag-Ncor,i_vorm,i_ho]  <- t.test(HUscores[vec_vorm[[i_vorm]],i_vraag],                                            ALscores[vec_vorm[[i_vorm]],i_vraag]                                           )$p.value
    #Berekenen gemiddelden per groep
    gem_HU[i_vraag-Ncor,i_vorm,i_ho]  <- t.test(HUscores[vec_vorm[[i_vorm]],i_vraag],                                            R6scores[vec_vorm[[i_vorm]],i_vraag]                                           )$estimate[1]
    gem_R6[i_vraag-Ncor,i_vorm,i_ho]  <- t.test(HUscores[vec_vorm[[i_vorm]],i_vraag],                                            R6scores[vec_vorm[[i_vorm]],i_vraag]                                           )$estimate[2]
    gem_AL[i_vraag-Ncor,i_vorm,i_ho]  <- t.test(HUscores[vec_vorm[[i_vorm]],i_vraag],                                            ALscores[vec_vorm[[i_vorm]],i_vraag]                                           )$estimate[2]
    
    #Berekenen verschil tussen gemiddelden (delta)
    diff_HUR6[i_vraag-Ncor,i_vorm,i_ho] <- mean(HUscores[vec_vorm[[i_vorm]],i_vraag],                                            na.rm = TRUE) - 
                                      mean(R6scores[vec_vorm[[i_vorm]],i_vraag],                                            na.rm = TRUE)
    diff_HUAL[i_vraag-Ncor,i_vorm,i_ho] <- mean(HUscores[vec_vorm[[i_vorm]],i_vraag],                                            na.rm = TRUE) - 
                                      mean(ALscores[vec_vorm[[i_vorm]],i_vraag],                                            na.rm = TRUE)
    }
  }
}
rm(Ncor)
```

# 6B. Multiple testing correctie p-waarden

Op het niveau van HU totaal worden in totaal 57 testen uitgevoerd
onderverdeeld in 16 verschillende thema's, zie ook het bestand
docs/NSE2021 MultipleTesting. Op het niveau van HU totaal zijn er dus 16
hypotheses die getest worden (sommige middels deel-vragen), namelijk
voor elk van deze thema's is de nul-hypothese: "Het gemiddelde antwoord
van HU studenten voor deze vraag is gelijk aan die van de R6 studenten".
Correctie voor deze multiple-testing vindt plaats via de
[Benjamini-Hochberg FDR
correctie](https://en.wikipedia.org/wiki/False_discovery_rate#Benjamini%E2%80%93Hochberg_procedure),
en dan de Benjamini-Yekutieli (BY) variant. Deze variant controleert ook
voor testen die mogelijk positief met elkaar gecorrigeerd zijn
(bijvoorbeeld de verschillende docent-deelvragen). Zie ook
[hier](https://projecteuclid.org/journals/annals-of-statistics/volume-29/issue-4/The-control-of-the-false-discovery-rate-in-multiple-testing/10.1214/aos/1013699998.full#:~:text=Abstract,many%20applied%20multiple%20testing%20problems.&text=For%20all%20other%20forms%20of,controls%20the%20false%20discovery%20rate.)

```{r FDR correctie}
p_HUR6_adj <- matrix(NA, Nvragen, Nvorm)
p_HUAL_adj <- matrix(NA, Nvragen, Nvorm)
for (i_vorm in 1:Nvorm)
{
  p_HUR6_adj[,i_vorm] <- p.adjust(p_HUR6[,i_vorm], method = "BY")
  p_HUAL_adj[,i_vorm] <- p.adjust(p_HUAL[,i_vorm], method = 'BY')
}
# Bekijken van verschuiving oorspronkelijke p en p_adj
i_vorm <- 4
plot(p_HUR6[,i_vorm], p_HUR6_adj[,i_vorm]); abline(h = 0.05, v=0.05)
rm(p_HUR6, p_HUAL)
```

```{r Visualiseren test-statistiek HU <> R6}
#Bekijken uitkomstmaten (delta inclusief significantie in kleur)
plot(p_HUR6_adj[,i_vorm])
abline(h = 0.05)
groepering <- ifelse(diff_HUR6[,i_vorm] > 0 & p_HUR6_adj[,i_vorm] < 0.05, 3, 
              ifelse(diff_HUR6[,i_vorm] < 0 & p_HUR6_adj[,i_vorm] < 0.05, 2, 
                                                                          1))
plot(diff_HUR6[,i_vorm], col = groepering, pch = 19, xlab = "NSE vraag", ylab = "Gemiddelde verschil (delta) tussen HU en R6")
```

```{r Visualiseren test-statistiek HU <> AL}
plot(p_HUAL_adj[,i_vorm])
abline(h = 0.05)
groepering <- ifelse(diff_HUAL[,i_vorm] > 0 & p_HUAL_adj[,i_vorm] < 0.05, 3,                  ifelse(diff_HUAL[,i_vorm] < 0 & p_HUAL_adj[,i_vorm] < 0.05, 2, 
                                                                          1))
plot(diff_HUAL[,i_vorm], col = groepering, pch = 19, xlab = "NSE vraag", ylab = "Gemiddelde verschil tussen HU en AL andere hogescholen")
```

# 7. Exporteren p waardes

Eerst de benodigde output pre-alloceren:

```{r Preallocatie van data frame}
nse_significanties <- data.frame(Opleidingsvorm3=character(),
                                 CrohoActueel   =character(),
                                 Vraag          =character(),
                                 Benchmark      =character(),
                                 p              =double(),
                                 Niveau         =character(),
                                 HUgem          =double(),
                                 Benchmarkgem   =double())
```

Vervolgens de verschillende analyses stuk voor stuk in een dataframe
zetten, en samenvoegen in 1:

```{r Vullen met HU totalen}
for (i_vorm in 1:Nvorm)
{
  tempR6 <- data.frame(Opleidingsvorm3 = NSEvormen[i_vorm], 
                     CrohoActueel    = rep("Totaal",Nvragen), 
                     Vraag           = NSEvragen, 
                     Benchmark       = rep("R6",Nvragen),  
                     p               = p_HUR6_adj[,i_vorm], 
                     Niveau          = rep("HU",Nvragen),
                     HUgem           = gem_HU[,i_vorm],
                     Benchmarkgem    = gem_R6[,i_vorm])

  tempAL <- data.frame(Opleidingsvorm3 = NSEvormen[i_vorm],
                     CrohoActueel    = rep("Totaal",Nvragen),
                     Vraag           = NSEvragen,
                     Benchmark       = rep("AL",Nvragen),
                     p               = p_HUAL_adj[,i_vorm],
                     Niveau          = rep("HU",Nvragen),
                     HUgem           = gem_HU[,i_vorm],
                     Benchmarkgem    = gem_AL[,i_vorm])
  
  #Toevoegen van tijdelijke dataframes aan output dataframe
  nse_significanties <- rbind(nse_significanties, tempR6, tempAL); 
}
rm(tempR6, tempAL)

```

Resultaten wegschrijven

```{r Wegschrijven naar .csv}
write.csv2(nse_significanties, file = "~/research-drive/M21033303_DenA (Projectfolder)/DA_Onderzoek/2021nse/data_uit/NSEsignificantietabel.csv")
```
